<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Flip Betting Game</title>
    <link rel="stylesheet" href="/static/css/coin.css">
</head>
<body>
    <div class="game-container">
        <h1>Coin Flip Betting Game</h1>
        <!-- Dynamic Wallet Balance -->
        <div class="balance" id="balance">Loading...</div>

        <script>
            // Fetch wallet balance from the backend and update dynamically
            function fetchBalance() {
                fetch('/get_user')
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                        } else {
                            document.getElementById("balance").innerText = `â‚¹${data.wallet_balance}`;
                        }
                    })
                    .catch(err => console.error("Error fetching balance:", err));
            }
            fetchBalance(); // Call function on page load
        </script>

        <!-- Input Field for Bet Amount -->
        <input type="number" id="betAmount" class="input-field" placeholder="Bet Amount" min="1">

        <!-- Buttons for Heads and Tails -->
        <div class="buttons">
            <button class="button" onclick="placeBet('heads')">Heads</button>
            <button class="button" onclick="placeBet('tails')">Tails</button>
        </div>

        <!-- Display Result -->
        <div class="result" id="result">Place your bet to start!</div>
        <!-- Display Win/Loss Stats -->
        <div class="stats" id="stats">Wins: 0 | Losses: 0</div>

        <!-- Game History -->
        <div class="history-container" id="history">
            <table>
                <thead>
                    <tr>
                        <th>Game ID</th>
                        <th>Time</th>
                        <th>Bet</th>
                        <th>Outcome</th>
                        <th>Result</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <!-- Game History will be appended here -->
                </tbody>
            </table>
        </div>

        <!-- Reset Button -->
        <button class="button" onclick="resetGame()">Reset Game</button>
    </div>

    <!-- Coin Flip Sound -->
    <audio id="flipSound" src="https://www.soundjay.com/coin-sounds/coin-flip-1.mp3" preload="auto"></audio>
    
    <!-- Game Logic -->
    <script>
        let balance = 100;
        let wins = 0;
        let losses = 0;
        let gameId = 1;

        function updateStats() {
            document.getElementById("stats").innerText = `Wins: ${wins} | Losses: ${losses}`;
        }

        function updateHistory(result, bet, outcome, newBalance) {
            const historyBody = document.getElementById("historyBody");
            const currentTime = new Date().toLocaleTimeString();
            const historyRow = document.createElement("tr");
            historyRow.innerHTML = `
                <td>${gameId}</td>
                <td>${currentTime}</td>
                <td>${bet.toUpperCase()}</td>
                <td>${outcome.toUpperCase()}</td>
                <td>${result}</td>
                <td>â‚¹${newBalance}</td>
            `;
            gameId++;
            historyBody.appendChild(historyRow);
        }

        function placeBet(bet) {
            const betAmount = parseInt(document.getElementById("betAmount").value);

            if (isNaN(betAmount) || betAmount <= 0) {
                document.getElementById("result").innerText = "Please enter a valid bet amount!";
                return;
            }

            // Send bet to the backend
            fetch('/coin/place_bet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prediction: bet,
                    bet_amount: betAmount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById("result").innerText = data.error;
                } else {
                    balance = data.new_balance;
                    document.getElementById("balance").innerText = `â‚¹${balance}`;
                    document.getElementById("result").innerText = data.win
                        ? `ðŸŽ‰ You won â‚¹${data.winnings}! Outcome: ${data.outcome.toUpperCase()}`
                        : `ðŸ˜ž You lost. Outcome: ${data.outcome.toUpperCase()}`;
                    updateHistory(data.win ? "Win" : "Loss", bet, data.outcome, balance);
                }
            })
            .catch(err => {
                console.error("Error:", err);
                document.getElementById("result").innerText = "An error occurred!";
            });
        }

        function resetGame() {
            balance = 100;
            wins = 0;
            losses = 0;
            gameId = 1;
            updateStats();
            document.getElementById("result").innerText = "Place your bet to start!";
            document.getElementById("betAmount").value = "";
            document.getElementById("historyBody").innerHTML = ""; // Clear history table
            fetchBalance(); // Refresh balance from the backend
        }
    </script>
</body>
</html>
